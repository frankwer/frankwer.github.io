<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Polestar 2 Difi stats</title>
    <script src="https://unpkg.com/vue/dist/vue.min.js"></script>
    <!--<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>-->
    <script src="https://unpkg.com/vue-router/dist/vue-router.js"></script>
    <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
    <!--<script src="https://unpkg.com/axios/dist/axios.min.js"></script>-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
    <!--<script src="https://unpkg.com/vue-chartjs/dist/vue-chartjs.min.js"></script>-->

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />
    <style>

    </style>
  </head>
  <body>
  <!--
  <div id="app">
   <router-link to="/rapport">Rapport</router-link>
      <router-link to="/rapport2">Rapport 2</router-link>

     <div>
        <router-view></router-view>
      </div>

  </div>
-->

  <div id="rapport">
  <!--
  <div>Antall registrerte Polestar 2: {{antallitems}} {{vinnummer[0]}}</div>
  
  <barchart :chartdata="chartData" :options="options" :styles="chartStyles" :initdata="initdata" title="Antall biler per måned"></barchart>
-->
  </div>

  </body>

  <script type="text/javascript">
  
/*
const Bar = {
  template: `<div>bar</div>`
};


const router = new VueRouter({
  routes: [
    {
      path: "/rapport",
      component: rapportapp
    },
    {
      path: "/rapport2",
      component: Bar
    }
  ]
});

const app = new Vue({
  router,
  el: "#app"
});
*/

function randomHex(length) {
    var random_string = '';
    if(!length){
        length = 1;
    }
    for(var i=0; i<length; i+=1){
        random_string += Math.floor(Math.random() * 15).toString(16);
    }
    return random_string;
}

function guid() {
    return randomHex(8);
}

const apiDoc = "https://hotell.difi.no/?dataset=vegvesen/kjoretoy"

const apiUrl="https://hotell.difi.no/api/json/vegvesen/kjoretoy?query=polestar 2"

const getCars = async function(pageNo = 1) {
  let actualUrl=apiUrl + `&page=${pageNo}`;
  var apiResults=await fetch(actualUrl,/* {
    credentials: 'include',
    headers:{
    'Access-Control-Allow-Origin':'*'
    }}*/)
  .then(resp=>{
    return resp.json();
  });
  return apiResults;
}

const getEntireCarList = async function(index = 1) {
  const results = await getCars(index);
  if (results.entries.length>0) {
    return results.entries.concat(await getEntireCarList(index+1));
  } else {
    return results.entries;
  }
};

function convertDate(str)
{
  var year = str.slice(0,4)
  var month = str.slice(4,6)
  var day = str.slice(6,8)

  return `${day}.${month}`
}

const countOccurrences = arr => arr.reduce((prev, curr) => (prev[curr] = ++prev[curr] || 1, prev), {})

function analyzeData(tempdata) {

    var occurences = countOccurrences(tempdata)

    var templabels = []
    var tempdata = []

    for (const [key, value] of Object.entries(occurences)) {
      
      templabels.push(convertDate(key))
      tempdata.push(value)
    }

    return {'labels': templabels, 'data': tempdata}
}



Vue.component('barchart', {
props: ['chartdata', 'data', 'labels', 'options', 'type', 'title', 'initdata'],
data: function() {
    return {
        mychart: null,
        id: guid()
    }
},
methods: {
    initchart: function() {
        var ctx = document.getElementById(this.id).getContext('2d');
        this.mychart = new Chart(ctx, {
                    type: this.type ? this.type : 'bar',
                    data: {
                        labels: this.chartdata.labels ? this.chartdata.labels : [],
                        datasets: this.chartdata.datasets ? this.chartdata.datasets : []
                        },
                    options: this.options
                })
         }
       
},
watch: {
    initdata: {
      handler(val, oldval){

        if (val) {
          this.initchart()
        }
        else{
          this.mychart.update()
        }

      }
    },
    chartdata: {
        immediate: false,
        deep: false,
        handler(val, oldval) {

            if (!this.mychart)
            {
                this.initchart()
                //this.mychart.update();
            }
            else if (this.mychart && val)
            {
                //this.mychart.update();
            }

        }
    }
},
mounted() {

},
template: `<div><canvas :id="id"></canvas></div>`

})




var rapportapp = new Vue({
      el: '#rapport',
      //delimiters: ['[[',']]'],
      data: {
        urlbase: "https://hotell.difi.no/api/json/vegvesen/kjoretoy?query=",
        antallsider: 1,
        antallitems: 0,
        initdata: false,
        initdata2: false,
        chartData: {
          labels: [],
          datasets: [
            {
              label: 'Antall biler',
              data: [],
              fill: false,
              borderColor: '#000',
              backgroundColor: '#2554FF',
              borderWidth: 1
            }
          ]
        },
        chartData2: {
          labels: [],
          datasets: [
            {
              label: 'Fordeling av farger',
              data: [],
              fill: false,
              borderColor: '#000',
              backgroundColor: '#2554FF',
              borderWidth: 1
            }
          ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 0.667
            //cutoutPercentage: 80
        },
        registrert: [],
        vinnummer: [],
        farge: [],
        registrert_status: [],
        registrert_status_data: null,
        fargedata: null,
        fargekoder: {
          "01": {farge: "Snow", webcol: "#f5f5f5"}, //	Hvit (også antikkhvit, offwhite)
          "03": {farge: "Midnight", webcol: "#183a50" },  //  Blå
          "05": {farge: "Thunder / Magnesium / Moon", webcol: "#606163"},  //  Grå
          "06": {farge: "Void", webcol: "#000"}, //  Svart (også blåsvart, grafitt mørk, gråsort, koksgrå mørk, koksgrå mørk metallic)
          "98": {farge: "Magnesium", webcol: ""}, // Magnesium?
          "99": {farge: "Moon", webcol: ""} // Moon?
        },
        kjoretoyList: null,
        documentHeight: null
      },
      methods: {
        processData: function(data)
        {
          var adata = analyzeData(data)
          this.chartData.labels = adata.labels
          this.chartData.datasets[0].data = adata.data

          this.initdata = true

        },
        processData2: function(coldata)
        {
           var labels = []
           var data = []
           var color = []

           for (const [key, value] of Object.entries(coldata)) {
            
            labels.push(this.fargekoder[key].farge)
            data.push(Number((value / this.antallitems) * 100).toFixed(2))
            color.push(this.fargekoder[key].webcol)
          }

            this.chartData2.labels = labels
            this.chartData2.datasets[0].data = data
            this.chartData2.datasets[0].backgroundColor = color
            this.initdata2 = true

        }
      },
      watch: {
        chartData: function(val, oldval)
        {

        },
        kjoretoyList: {
          immediate: false,
          deep: false,
          handler(val, oldval)
          {
            this.antallitems = val.length
            Object.entries(val).forEach(item => {
                  //this.registrert.push(item[1].tekn_reg_aar.slice(0,6))
                  this.registrert.push(item[1].tekn_reg_aar)
                  this.vinnummer.push(item[1].tekn_unr)
                  this.farge.push(item[1].tekn_farge)

                  this.registrert_status.push(item[1].tekn_reg_status)
            });

            this.vinnummer.sort()
            this.processData(this.registrert)
            this.fargedata = countOccurrences(this.farge)
            this.registrert_status_data = countOccurrences(this.registrert_status)
            //this.processData2(this.fargedata)
          }
        },
        fargedata: {
          immediate: false,
          deep: false,
          handler(val, oldval) {

            this.processData2(val)
          }
        },
        registrert: {
            immediate: false,
            deep: true,
            handler(val, oldval) {
                

                //this.processData2(val)      
          }
        }
      },
      computed: {
        chartStyles() {
            return {
                //height: (this.documentHeight / 2) + 'px',
                height: '400px',
                position: 'relative'
                }
        }
      },
      async mounted() {
             
             this.documentHeight = document.documentElement.scrollHeight
             this.kjoretoyList=await getEntireCarList();
      },
      template: `
      <div class="container-fluid">
      <div class="row">
      <div class="col-sm">
      <ul class="list-group">
      <li class="list-group-item">Antall registrerte Polestar 2: <b>{{antallitems}}</b></li>
      <li class="list-group-item">Høyeste VIN-nummer: <b>{{vinnummer[vinnummer.length-1]}}</b></li>
      </ul>
      </div>
      <div class="col-sm">
      <ul class="list-group">
      <li class="list-group-item">Registreringstatus: <b>{{this.registrert_status_data}}</b></li>
      <li class="list-group-item">Kilde: <a href="https://www.difi.no/" target="_blank">difi.no</a> ( <a href="https://data.norge.no/datasets/a8533876-cca7-4417-90be-b368f7d9542c" target="_blank">Kjøretøyopplysninger</a> )</li>
      </ul>
      </div>
      </div>


      
      <barchart :chartdata="chartData" :options="options" :initdata="initdata" title="Antall biler per måned"></barchart>
      <barchart :chartdata="chartData" :options="options" :initdata="initdata" title="Antall biler per måned" type="line"></barchart>
            <div class="row">
      <div class="col-sm">
      <h4><span class="badge badge-secondary">Fordeling av farger:</span></h4>
      <div class="alert alert-secondary" role="alert">
      <ul class="list-group list-group-horizontal">
      <template v-for="(item, index) in fargedata">
          <li class="list-group-item">{{fargekoder[index].farge}}:  <b>{{item}} biler</b></li> 
      </template>
      </ul>
      </div>
      </div>
      </div>
      <barchart :chartdata="chartData2" :options="options" :initdata="initdata2" title="Fordeling av farger" type="doughnut"></barchart>
      </div>`

    });



    Vue.config.devtools = true;
  
  </script>
  </html>