<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Polestar 2 Difi stats</title>
    <script src="https://unpkg.com/vue/dist/vue.min.js"></script>
    <!--<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>-->
    <script src="https://unpkg.com/vue-router/dist/vue-router.js"></script>
    <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
    <!--<script src="https://unpkg.com/axios/dist/axios.min.js"></script>-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
    <!--<script src="https://unpkg.com/vue-chartjs/dist/vue-chartjs.min.js"></script>-->

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />
    <style>

    </style>
  </head>
  <body>
  <!--
  <div id="app">
   <router-link to="/rapport">Rapport</router-link>
      <router-link to="/rapport2">Rapport 2</router-link>

     <div>
        <router-view></router-view>
      </div>

  </div>
-->

  <div id="rapport">
  <!--
  <div>Antall registrerte Polestar 2: {{antallitems}} {{vinnummer[0]}}</div>
  
  <barchart :chartdata="chartData" :options="options" :styles="chartStyles" :initdata="initdata" title="Antall biler per måned"></barchart>
-->
  </div>

  </body>

  <script type="text/javascript">
  
/*
const Bar = {
  template: `<div>bar</div>`
};


const router = new VueRouter({
  routes: [
    {
      path: "/rapport",
      component: rapportapp
    },
    {
      path: "/rapport2",
      component: Bar
    }
  ]
});

const app = new Vue({
  router,
  el: "#app"
});
*/

function randomHex(length) {
    var random_string = '';
    if(!length){
        length = 1;
    }
    for(var i=0; i<length; i+=1){
        random_string += Math.floor(Math.random() * 15).toString(16);
    }
    return random_string;
}

function guid() {
    return randomHex(8);
}

const apiUrl="https://hotell.difi.no/api/json/vegvesen/kjoretoy?query=polestar 2"

const getCars = async function(pageNo = 1) {
  let actualUrl=apiUrl + `&page=${pageNo}`;
  var apiResults=await fetch(actualUrl)
  .then(resp=>{
    return resp.json();
  });
  return apiResults;
}

const getEntireCarList = async function(index = 1) {
  const results = await getCars(index);
  if (results.entries.length>0) {
    return results.entries.concat(await getEntireCarList(index+1));
  } else {
    return results.entries;
  }
};

function convertDate(str)
{
  var year = str.slice(0,4)
  var month = str.slice(4,6)
  var day = str.slice(6,8)

  console.log(year + " : " + month + " : " + day)

  return `${day}.${month}`
}

const countOccurrences = arr => arr.reduce((prev, curr) => (prev[curr] = ++prev[curr] || 1, prev), {})

function analyzeData(tempdata) {

    var occurences = countOccurrences(tempdata)

    var templabels = []
    var tempdata = []

    for (const [key, value] of Object.entries(occurences)) {
      
      templabels.push(convertDate(key))
      tempdata.push(value)
    }

    return {'labels': templabels, 'data': tempdata}
}



Vue.component('barchart', {
props: ['chartdata', 'data', 'labels', 'options', 'type', 'title', 'initdata'],
data: function() {
    return {
        mychart: null,
        id: guid()
    }
},
methods: {
    initchart: function() {
        var ctx = document.getElementById(this.id).getContext('2d');
        this.mychart = new Chart(ctx, {
                    type: this.type ? this.type : 'bar',
                    data: {
                        labels: this.chartdata.labels ? this.chartdata.labels : [],
                        datasets: this.chartdata.datasets ? this.chartdata.datasets : []
                        },
                    options: this.options
                })
         }
       
},
watch: {
    initdata: {
      handler(val, oldval){

        if (val) {
          console.log("INITDATA")
          this.initchart()
        }
        else{
          this.mychart.update()
        }

      }
    },
    chartdata: {
        immediate: false,
        deep: false,
        handler(val, oldval) {

          console.log(val)

            if (!this.mychart)
            {
                this.initchart()
                //this.mychart.update();
            }
            else if (this.mychart && val)
            {
                //this.mychart.update();
            }

        }
    }
},
mounted() {

},
template: `<div><canvas :id="id"></canvas></div>`

})




var rapportapp = new Vue({
      el: '#rapport',
      //delimiters: ['[[',']]'],
      data: {
        urlbase: "https://hotell.difi.no/api/json/vegvesen/kjoretoy?query=",
        antallsider: 1,
        antallitems: 0,
        initdata: false,
        chartData: {
          labels: [],
          datasets: [
            {
              label: 'Antall biler',
              data: [],
              fill: true,
              borderColor: '#000',
              backgroundColor: '#2554FF',
              borderWidth: 1
            }
          ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            //cutoutPercentage: 80
        },
        registrert: [],
        vinnummer: [],
        kjoretoyList: null
      },
      methods: {
        processData2: function(data)
        {
          var adata = analyzeData(data)
          this.chartData.labels = adata.labels
          this.chartData.datasets[0].data = adata.data

          this.initdata = true

        }
      },
      watch: {
        chartData: function(val, oldval)
        {
          console.log("CHARTDATA")
        },
        kjoretoyList: {
          immediate: false,
          deep: false,
          handler(val, oldval)
          {
            this.antallitems = val.length
            Object.entries(val).forEach(item => {
                  //this.registrert.push(item[1].tekn_reg_aar.slice(0,6))
                  this.registrert.push(item[1].tekn_reg_aar)
                  this.vinnummer.push(item[1].tekn_unr)
            });

            this.vinnummer.sort()
            this.processData2(this.registrert)

            console.log("KJØRETØYLIST")
          }
        },
        registrert: {
            immediate: false,
            deep: true,
            handler(val, oldval) {
                

                //this.processData2(val)      
          }
        }
      },
          computed: {
            chartStyles() {
                return {
                    height: '200px',
                    position: 'relative'
                    }
            }
          },
      async mounted() {
             this.kjoretoyList=await getEntireCarList();
      },
      template: `
      <div class="container-fluid">
      <div class="row">
      <div class="col-sm">
      <ul class="list-group">
      <li class="list-group-item">Antall registrerte Polestar 2: <b>{{antallitems}}</b></li>
      <li class="list-group-item">Høyeste VIN-nummer: <b>{{vinnummer[vinnummer.length-1]}}</b></li>
      </ul>
      </div>
      <div class="col-sm"></div>
      </div>
      <barchart :chartdata="chartData" :options="options" :styles="chartStyles" :initdata="initdata" title="Antall biler per måned"></barchart>

      </div>`

    });



    Vue.config.devtools = true;
  
  </script>
  </html>